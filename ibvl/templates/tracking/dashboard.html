<!DOCTYPE html>
<html>
  <head>
    <title>Variome Tracking Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.css"
      integrity="sha512-t38vG/f94E72wz6pCsuuhcOPJlHKwPy+PY+n1+tJFzdte3hsIgYE7iEpgg/StngunGszVMrRfvwZinrza0vMTA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        padding: 1.5em;
        font-family: Arial, sans-serif;
      }
      #tracking-filters {
        float: left;
        width: 25%;
        margin-right: 2%;
      }
      #tracking-stats {
        float: left;
        width: 73%;
      }
      .warning {
        color: red;
      }
      .chart-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
      }
      .chart-container canvas {
        flex: 0 1 48%;
        max-width: 48%;
        margin-bottom: 2em;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 2em;
      }
      th, td {
        padding: 0.75em;
        text-align: left;
        border: 1px solid #ddd;
      }
      th {
        background-color: #f2f2f2;
      }
      h4 {
        margin-top: 2em;
      }
    </style>
  </head>
  <body>
    <h2>Variome Tracking Dashboard</h2>
    <div id="tracking-filters">
      <form method="GET">
        <table>
          <tr>
            <th><label for="id_start">Start date:</label></th>
            <td><input type="date" name="start" required id="id_start" value="{{ form.start.value }}"></td>
          </tr>
          <tr>
            <th><label for="id_end">End date:</label></th>
            <td><input type="date" name="end" required id="id_end" value="{{ form.end.value }}"></td>
          </tr>
          <tr>
            <th><label for="id_variant">Variant:</label></th>
            <td><input type="text" name="variant" id="id_variant" value="{{ form.variant.value }}"></td>
          </tr>
          <tr>
            <th><label for="id_user">User:</label></th>
            <td>
              <select name="user" id="id_user" multiple>
                {% for user in form.user.field.queryset %}
                  <option value="{{ user.id }}" {% if user.id in form.user.value %}selected{% endif %}>{{ user.get_full_name }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
        </table>
        <button type="submit" class="btn waves-effect waves-light">Submit</button>
      </form>
    </div>

    <div id="tracking-stats">
      <h4>Statistics</h4>
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th># Site Visits</th>
            <th># Site Visits (24h)</th>
            <th>Avg. Time on Site</th>
            <th>Avg. # Variant Pages / Site Visit</th>
            <th># Variants Queried</th>
          </tr>
        </thead>
        <tbody>
          {% for stat in user_stats %}
          <tr>
            <th>{{ stat.user.get_full_name }}</th>
            <td>{{ stat.visit_count }}</td>
            <td>{{ stat.access_count }}</td>
            <td>{{ stat.time_on_site }}</td>
            <td>{{ stat.pages_per_visit }}</td>
            <td>{{ stat.variants_queried_count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <h4>Variant Views</h4>
      <table>
        <thead>
          <tr>
            <th>Variant</th>
            <th>View Time</th>
            <th>Visitor</th>
          </tr>
        </thead>
        <tbody>
          {% for pageview in variant_pageviews %}
          <tr>
            <td><a href="{{ pageview.variant_url }}" target="_blank">{{ pageview.variant }}</a></td>
            <td>{{ pageview.view_time }}</td>
            <td>
              <ul>
                <li>{{ pageview.visitor.user.get_full_name }}</li>
                <li>{{ pageview.visitor.user.email }}</li>
                <li>({{ pageview.visitor.user.username }})</li>
              </ul>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <h4>Variant/Gene Access Details</h4>
      <table>
        <thead>
          <tr>
            <th>Variant/Gene</th>
            <th># of Users Accessed</th>
            <th>Users</th>
          </tr>
        </thead>
        <tbody>
          {% for detail in variant_access_details %}
          <tr>
            <td>{{ detail.name }}</td>
            <td>{{ detail.user_count }}</td>
            <td>
              <ul>
                {% for user in detail.users %}
                <li>{{ user.get_full_name }} ({{ user.email }})</li>
                {% endfor %}
              </ul>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div >
      <canvas id="siteVisitsChart"></canvas>
      <canvas id="timeOnSiteChart"></canvas>
      <canvas id="variantsQueriedChart"></canvas>
    </div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.js"
      integrity="sha512-m2PhLxj2N91eYrIGU2cmIu2d0SkaE4A14bCjVb9zykvp6WtsdriFCiXQ/8Hdj0kssUB/Nz0dMBcoLsJkSCto0Q=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        M.AutoInit();
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const siteVisitsCtx = document.getElementById('siteVisitsChart').getContext('2d');
        const timeOnSiteCtx = document.getElementById('timeOnSiteChart').getContext('2d');
        const variantsQueriedCtx = document.getElementById('variantsQueriedChart').getContext('2d');

        const userLabels = JSON.parse('{{ user_labels|escapejs }}');
        const siteVisitsData = JSON.parse('{{ site_visits_data|escapejs }}');
        const timeOnSiteData = JSON.parse('{{ time_on_site_data|escapejs }}');
        const variantsQueriedData = JSON.parse('{{ variants_queried_data|escapejs }}');

        const chartOptions = {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom'
            }
          }
        };

        const siteVisitsChart = new Chart(siteVisitsCtx, {
          type: 'bar',
          data: {
            labels: userLabels,
            datasets: [{
              label: '# Site Visits',
              data: siteVisitsData,
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
            }]
          },
          options: chartOptions
        });

        const timeOnSiteChart = new Chart(timeOnSiteCtx, {
          type: 'bar',
          data: {
            labels: userLabels,
            datasets: [{
              label: 'Avg. Time on Site (minutes)',
              data: timeOnSiteData,
              backgroundColor: 'rgba(153, 102, 255, 0.2)',
              borderColor: 'rgba(153, 102, 255, 1)',
              borderWidth: 1
            }]
          },
          options: chartOptions
        });

        const variantsQueriedChart = new Chart(variantsQueriedCtx, {
          type: 'bar',
          data: {
            labels: userLabels,
            datasets: [{
              label: '# Variants Queried',
              data: variantsQueriedData,
              backgroundColor: 'rgba(255, 159, 64, 0.2)',
              borderColor: 'rgba(255, 159, 64, 1)',
              borderWidth: 1
            }]
          },
          options: chartOptions
        });
      });
    </script>
  </body>
</html>
